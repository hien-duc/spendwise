-- Get monthly financial summary
create or replace function get_monthly_summary(
    user_id_param uuid,
    year_param integer,
    month_param integer
)
returns table (
    total_income decimal(12,2),
    total_expense decimal(12,2),
    total_investment decimal(12,2),
    net_amount decimal(12,2)
) as $$
begin
    return query
    select
        coalesce(sum(case when type = 'income' then amount else 0 end), 0.00) as total_income,
        coalesce(sum(case when type = 'expense' then amount else 0 end), 0.00) as total_expense,
        coalesce(sum(case when type = 'investment' then amount else 0 end), 0.00) as total_investment,
        coalesce(sum(case 
            when type = 'income' then amount 
            when type in ('expense', 'investment') then -amount
        end), 0.00) as net_amount
    from transactions
    where user_id = user_id_param
    and extract(year from date) = year_param
    and extract(month from date) = month_param;
end;
$$ language plpgsql;